{% extends 'base.html.twig' %}

{% block title %}Calendrier des congés - Équipe{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/5.10.2/main.min.css">
    <style>
             #calendar {
                 max-width: 1200px;
                 min-height: 700px;
                 margin: 0 auto;
                 padding: 20px;
                 background-color: #ffffff;
                 border-radius: 10px;
                 box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
             }

            .container {
                max-width: 1400px;
            }

            .calendar-legend {
                display: flex;
                justify-content: center;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }

            .legend-item {
                display: flex;
                align-items: center;
                margin: 0 10px;
            }

            .color-box {
                width: 15px;
                height: 15px;
                margin-right: 5px;
                display: inline-block;
            }

            .fc-daygrid-event {
                cursor: pointer;
            }

            .month-navigation {
                text-align: center;
                margin-bottom: 20px;
            }

            .tooltip-content {
                padding: 10px;
                max-width: 250px;
            }

            .tooltip-content p {
                margin: 5px 0;
            }
        </style>
    {% endblock %}


{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/locales/fr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tippy.js@6.3.1/dist/tippy-bundle.umd.min.js"></script>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            const calendarData = {{ calendarData|json_encode(constant('JSON_UNESCAPED_UNICODE'))|raw }};

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'fr',
                headerToolbar: {
                    left: 'title',
                    center: '',
                    right: 'prev,next today'
                },
                initialDate: '{{ currentYear }}-{{ '%02d'|format(currentMonth) }}-01',
                events: calendarData,
                eventDidMount: function(info) {
                    tippy(info.el, {
                        content: createTooltipContent(info.event),
                        allowHTML: true,
                        placement: 'top',
                        arrow: true,
                        theme: 'light-border'
                    });
                }
            });

            calendar.render();

            document.getElementById('prevMonth').addEventListener('click', function() {
                let month = {{ currentMonth }};
                let year = {{ currentYear }};

                month--;
                if (month === 0) {
                    month = 12;
                    year--;
                }

                window.location.href = '{{ path('stats_team_calendar') }}?month=' + month + '&year=' + year;
            });

            document.getElementById('nextMonth').addEventListener('click', function() {
                let month = {{ currentMonth }};
                let year = {{ currentYear }};

                month++;
                if (month === 13) {
                    month = 1;
                    year++;
                }

                window.location.href = '{{ path('stats_team_calendar') }}?month=' + month + '&year=' + year;
            });

            function createTooltipContent(event) {
                const props = event.extendedProps;
                return `
                    <div class="tooltip-content">
                        <p><strong>Employé:</strong> ${props.userName || 'N/A'}</p>
                        <p><strong>Type:</strong> ${getLeaveTypeName(props.leaveType || 'Fermeture')}</p>
                        <p><strong>Période:</strong> ${formatDate(event.start)} - ${formatDate(event.end)}</p>
                        ${props.comment ? `<p><strong>Commentaire:</strong> ${props.comment}</p>` : ''}
                        ${props.status ? `<p><strong>Statut:</strong> ${getStatusName(props.status)}</p>` : ''}
                    </div>
                `;
            }

            function formatDate(date) {
                if (!date) return '';
                return new Date(date).toLocaleDateString('fr-FR');
            }

            function getLeaveTypeName(type) {
                const types = {
                    'CP': 'Congé payé',
                    'CM': 'Congé maladie',
                    'RTT': 'RTT'
                };
                return types[type] || type;
            }

            function getStatusName(status) {
                const statuses = {
                    'PENDING': 'En attente',
                    'APPROVED': 'Approuvé',
                    'REJECTED': 'Refusé'
                };
                return statuses[status] || status;
            }
        });
    </script>
{% endblock %}

{% block body %}
    <div class="container mt-4">
        <h1 class="text-center mb-4">Calendrier des congés de l'équipe</h1>

        <div class="month-navigation">
            <button id="prevMonth" class="btn btn-outline-primary">&laquo; Mois précédent</button>
            <button id="nextMonth" class="btn btn-outline-primary">Mois suivant &raquo;</button>
        </div>

        <div class="calendar-legend">
            <div class="legend-item">
                <span class="color-box" style="background-color: #28a745;"></span>
                <span>Congé payé</span>
            </div>
            <div class="legend-item">
                <span class="color-box" style="background-color: #dc3545;"></span>
                <span>Congé maladie</span>
            </div>
            <div class="legend-item">
                <span class="color-box" style="background-color: #6f42c1;"></span>
                <span>RTT</span>
            </div>
            <div class="legend-item">
                <span class="color-box" style="background-color: #f44336;"></span>
                <span>Fermeture</span>
            </div>
        </div>

        <div id="calendar"></div>
    </div>
{% endblock %}
